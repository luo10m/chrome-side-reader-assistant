# å¼€å‘ã€ŒæŠ“å–ç½‘é¡µå†…å®¹åŠŸèƒ½ã€æ–‡æ¡£

**æœ¬æ‰©å±•ç°å·²æ”¯æŒã€Œç½‘é¡µæ­£æ–‡æŠ“å– + æµå¼æ‘˜è¦ã€ã€‚ä¸‹åˆ—æ–‡æ¡£æ¦‚è¿°æ•´ä½“æ¶æ„ã€ä¸»è¦æµç¨‹ã€å…³é”® API åŠæ³¨æ„äº‹é¡¹ï¼Œä¾¿äºåç»­ç»´æŠ¤ä¸äºŒæ¬¡å¼€å‘ã€‚**

## ä¸€ã€æ•´ä½“æ¶æ„

**â€¢ Content Scriptï¼ˆsrc/js/content-script.jsï¼‰**
**â€‘ è´Ÿè´£åœ¨æ¯ä¸ªæ ‡ç­¾é¡µæ³¨å…¥ï¼ŒDOM Ready åè‡ªåŠ¨æå– **`document.body.innerText`ï¼Œå¹¶å‘åå°å‘é€ã€‚
**â€‘ é€šè¿‡å®šæ—¶å™¨æ£€æµ‹ URL å˜åŒ–ï¼Œæ”¯æŒ SPA åº”ç”¨é¡µé¢å†…å®¹æ›´æ–°ã€‚
**â€‘ å¯å“åº”æ‰‹åŠ¨åˆ·æ–°è¯·æ±‚ï¼Œé‡æ–°æŠ“å–é¡µé¢å†…å®¹ã€‚

```
{ action: 'pageContent', url, content }
```

**â€¢ Backgroundï¼ˆchrome/background.jsï¼‰**
**â€‘ ç»´æŠ¤ **`pageCache`ï¼ˆæœ€å¤š 10 æ¡ï¼Œé”®ä¸º tabIdï¼‰ã€‚\*\*
\*\*â€‘ æš´éœ²å¤šç±»æ¶ˆæ¯ï¼š

1. **æ¥æ”¶ **`pageContent` â†’ æ›´æ–°ç¼“å­˜
2. **æ¥æ”¶ **`summarizePage` â†’ è°ƒç”¨ OpenAI æµå¼æ¥å£ï¼Œé€å—æŠŠæ‘˜è¦é€šè¿‡

`{ action: 'summaryStream', messageId, done, content }`
**ä¸‹å‘åˆ°ä¾§æ ã€‚**
**â€‘ æ‘˜è¦å®Œæˆåï¼ŒæŠŠã€ŒURL â†’ æ­£æ–‡ â†’ æ‘˜è¦ã€ä¸‰æ¡æ¶ˆæ¯é¡ºåºå†™å…¥æ ‡ç­¾é¡µç‰¹å®šçš„æ¶ˆæ¯å†å²
**ï¼ˆ`pageMessages_${tabId}`ï¼‰ï¼Œå®ç°å¤šæ ‡ç­¾é¡µèŠå¤©éš”ç¦»ã€‚\*\*

**â€¢ Side Panel UIï¼ˆsrc/js/modules/ai-chat.jsï¼‰**
**â€‘ æä¾› **"å¼€å§‹æ‘˜è¦"** æŒ‰é’®ï¼ˆid=`summarize-btn`ï¼‰ã€‚**
**â€‘ ç‚¹å‡»åå‘åå°å‘é€ `summarizePage`ï¼›æ¥æ”¶å¹¶å®æ—¶æ¸²æŸ“ `summaryStream`ã€‚**
**â€‘ å®Œæˆæˆ–å‡ºé”™åæ¢å¤æŒ‰é’®å¯ç”¨çŠ¶æ€ã€‚
**â€‘ æ ‡ç­¾é¡µåˆ‡æ¢æ—¶è‡ªåŠ¨åŠ è½½å¯¹åº”æ ‡ç­¾é¡µçš„å†…å®¹å’Œå†å²ã€‚

## äºŒã€æ¶ˆæ¯åè®®

**content-script â†’ background**
**â€¢ action: **`pageContent`
** payload: **`{ url, content }`

**side-panel â†’ background**
**â€¢ action: **`summarizePage`
** payload: **`{ tabId }` (å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰æ ‡ç­¾é¡µ)

**background â†’ side-panel**
**â€¢ action: **`summaryStream`
** payload: **`{ messageId, done, content }`

**background â†’ side-panelï¼ˆé”™è¯¯ï¼‰**
**â€¢ action: **`summaryError`
** payload: **`{ error }`

## ä¸‰ã€å…³é”®å­˜å‚¨ç»“æ„

**chrome.storage.local**
**â€¢ pageCache:**

```
{
  [tabId]: { url, content, timestamp }
}
```

**â€¢ pageMessages\_${tabId}: æ ‡ç­¾é¡µç‰¹å®šçš„æ¶ˆæ¯å†å²**
**â€¢ settings: ç”¨æˆ·è®¾ç½®ï¼ˆæ–°å¢å­—æ®µ **`defaultAI: 'openai'`ï¼‰

**å†…å­˜**
**â€¢ **`pageCache`ï¼šåŒä¸Šï¼Œå§‹ç»ˆä¸ storage åŒæ­¥\*\*
\*\*â€¢ `currentSettings`ï¼šåå°è¿è¡Œæ—¶çš„é…ç½®å¿«ç…§

## å››ã€ä¸»è¦å‡½æ•°

**content-script**
**â€¢ **`extractPageText()` â€“ æŠ“å–æ­£æ–‡å¹¶å‘é€
**â€¢ **`checkURLChange()` â€“ ç›‘æµ‹ URL å˜åŒ–ï¼Œæ”¯æŒ SPA åº”ç”¨

**background**
**â€¢ **`upsertPageCache(tabId, url, content)` â€“ å†™ç¼“å­˜ï¼Œè£å‰ªè‡³ 10 æ¡\*\*
**â€¢ `summarizeWithOpenAI(tabId, url, content)` â€“ è°ƒç”¨ OpenAI æ¥å£ï¼ˆæ”¯æŒæµå¼ï¼‰**
\*\*â€¢ `cacheTabHistory(tabId, url, pageText, summaryText)` â€“ å°†æ¶ˆæ¯å†™å…¥æ ‡ç­¾é¡µç‰¹å®šå†å²

**ai-chat.js**
**â€¢ **`initSummaryButton()` â€“ ç»‘å®šæŒ‰é’®äº‹ä»¶\*\*
**â€¢ `handleTabChange(tabId)` â€“ å¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢ï¼ŒåŠ è½½å¯¹åº”å†å²
**â€¢ `chrome.runtime.onMessage` â€“ æ¸²æŸ“æµå¼æ‘˜è¦

## äº”ã€UI å˜æ›´

**åœ¨ AI èŠå¤©æ¨¡å—ä¸­æ·»åŠ ï¼š**

```
<button id="summarize-btn" data-i18n="summarize_btn">å¼€å§‹æ‘˜è¦</button>
```

**CSS å¤ç”¨ç°æœ‰æŒ‰é’®æ ·å¼ï¼Œç‰¹æ®Šæ ·å¼å¯è‡ªè¡Œè¿½åŠ ã€‚**

## å…­ã€é…ç½®ä¸è¿è¡Œ

1. **åœ¨ã€Œè®¾ç½®ã€é¡µå¡«å†™ **`OpenAI API Key`ï¼Œä¿è¯ `defaultAI` ä¸º `openai`ã€‚
2. **é‡æ–°åŠ è½½æ‰©å±•ï¼›æ‰“å¼€ä»»æ„ç½‘é¡µ â†’ æ‰“å¼€ä¾§æ  â†’ ç‚¹å‡» \*\***å¼€å§‹æ‘˜è¦\*\*ã€‚
3. **æ‰©å±•æœ€å¤šç¼“å­˜ 10 ä¸ªæ ‡ç­¾é¡µæ­£æ–‡ï¼›å¯åœ¨åå°é‡è½½æˆ–å…³é—­æ ‡ç­¾åè‡ªåŠ¨å›æ”¶ã€‚**
4. **è‹¥éœ€åˆ‡æ¢è‡³ Ollamaï¼Œåªéœ€å°† **`defaultAI` åŠç›¸å…³ URL/Model æ”¹å›å¹¶å¤ç”¨ç°æœ‰é€»è¾‘ã€‚

## ä¸ƒã€æ³¨æ„äº‹é¡¹

**â€¢ å½“å‰æ­£æ–‡æå–ä»…ç”¨ **`innerText`ï¼Œå¤æ‚ç½‘é¡µå¯æ›¿æ¢ä¸º Readability ç­‰ç®—æ³•ã€‚\*\*
**â€¢ OpenAI æµå¼è¿”å›éµå¾ªå®˜æ–¹ SSE åè®®ï¼Œè§£ææ—¶åŠ¡å¿…å¿½ç•¥ `[DONE]`ã€‚**
**â€¢ Manifest V3 ä¸‹åå°ä¸ºé•¿é©»è„šæœ¬ï¼›è‹¥è¿ç§»è‡³ Service Workerï¼Œéœ€è¦é…åˆ `alarms` ä¿æ´»ã€‚**
**â€¢ è¶…é•¿ç½‘é¡µ for token å®‰å…¨å¯åœ¨ `summarizeWithOpenAI()` å†…éƒ¨å¢åŠ æˆªæ–­ï¼ˆå¦‚å‰ 10 000 å­—ç¬¦ï¼‰ã€‚**
**â€¢ ç°æœ‰é˜Ÿåˆ—å¤§å° 10 å¯åœ¨ `MAX_PAGE_CACHE` è°ƒæ•´ï¼›å¤§äº 10 è‡ªåŠ¨æŒ‰æ—¶é—´æ·˜æ±°æ—§é¡¹ã€‚**
**â€¢ å¤šæ ‡ç­¾éš”ç¦»ä½¿ç”¨ `tabId` ä¸ºé”®å­˜å‚¨å†…å®¹å’ŒèŠå¤©å†å²ï¼Œå®ç°ä¸åŒæ ‡ç­¾é¡µç‹¬ç«‹çš„ä½“éªŒã€‚
**â€¢ é¡µé¢å¯¼èˆªæ—¶ä¼šå‘é€é€šçŸ¥æ›´æ–° UI æ˜¾ç¤ºï¼Œä¿æŒç”¨æˆ·ä½“éªŒçš„è¿è´¯æ€§ã€‚

## å…«ã€åŠŸèƒ½æ–‡ä»¶æ¦‚è¿°

1. **`src/js/content-script.js`**
   **â€‘ è´Ÿè´£æŠ“å–é¡µé¢å†…å®¹**
   **â€‘ ç›‘å¬ URL å˜åŒ–**
   **â€‘ å“åº”æ‰‹åŠ¨åˆ·æ–°è¯·æ±‚**

2. **`chrome/background.js`**
   **â€‘ ç®¡ç†é¡µé¢å†…å®¹ç¼“å­˜**
   **â€‘ å¤„ç†æ‘˜è¦è¯·æ±‚**
   **â€‘ è°ƒç”¨ OpenAI API ç”Ÿæˆæ‘˜è¦**
   **â€‘ ç»´æŠ¤å¤šæ ‡ç­¾é¡µæ•°æ®éš”ç¦»**

3. **`src/js/index.js`**
   **â€‘ æ‰©å±•ä¸»å…¥å£**
   **â€‘ åˆå§‹åŒ–å„åŠŸèƒ½æ¨¡å—**
   **â€‘ ç®¡ç† UI åˆ‡æ¢**

4. **`src/js/modules/ai-chat.js`**
   **â€‘ å®ç°èŠå¤©ç•Œé¢**
   **â€‘ æä¾›æ‘˜è¦æŒ‰é’®å’Œå¤„ç†é€»è¾‘**
   **â€‘ æ˜¾ç¤ºæ‘˜è¦ç»“æœ**
   **â€‘ ç®¡ç†æ ‡ç­¾é¡µç‰¹å®šçš„æ¶ˆæ¯å†å²**

# å‚è€ƒè®¾è®¡

**æ ¸å¿ƒæ”¹åŠ¨åŒ…å« 3 ä¸ªæ–‡ä»¶ï¼š**

1. **src/js/content-script.js**
   **â€‘ æ¯æ¬¡é¡µé¢åŠ è½½å®ŒæˆåæŠ“å–æ­£æ–‡æ–‡æœ¬å¹¶å‘ç»™åå°**
   **â€‘ å®šæ—¶æ£€æµ‹ URL å˜åŒ–ï¼Œæ”¯æŒ SPA åº”ç”¨**
2. **chrome/background.js**
   **â€‘ ç»´æŠ¤æœ€å¤š 10 æ¡çš„ã€Œç½‘é¡µå†…å®¹ç¼“å­˜é˜Ÿåˆ—ã€**
   **â€‘ æ–°å¢ "pageContent / summarizePage / summaryStream / summaryError" æ¶ˆæ¯åè®®**
   **â€‘ é»˜è®¤ä½¿ç”¨ OpenAIï¼Œæ”¯æŒæµå¼æ‘˜è¦**
   **â€‘ å°†ç½‘é¡µå†…å®¹ + æ‘˜è¦ä½œä¸ºå¯¹è¯å†å²ç¼“å­˜åˆ°æ ‡ç­¾é¡µç‰¹å®šçš„å­˜å‚¨ä¸­**
3. **src/js/modules/ai-chat.js**
   **â€‘ åœ¨èŠå¤© UI ä¸­æä¾›"å¼€å§‹æ‘˜è¦"æŒ‰é’®ç›‘å¬**
   **â€‘ å®æ—¶æ¥æ”¶å¹¶æ¸²æŸ“åå°æ¨é€çš„æµå¼æ‘˜è¦ç»“æœ**
   **â€‘ å¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢ï¼ŒåŠ è½½å¯¹åº”å†å²**

**åªéœ€æŠŠä¸‹é¢ä»£ç ç‰‡æ®µç›´æ¥æ›¿æ¢/åˆå¹¶åˆ°å¯¹åº”æ–‡ä»¶å³å¯è¿è¡Œã€‚**

```
// -------------------------------------------------------------
// content-script.js æ–°å¢é€»è¾‘
// -------------------------------------------------------------
function extractPageText() {
    try {
        const text = document.body ? document.body.innerText : '';
        chrome.runtime.sendMessage({
            action: 'pageContent',
            url: location.href,
            content: text
        });
    } catch (e) {
        console.error('Failed to extract page text', e);
    }
}

// æ£€æµ‹URLå˜åŒ–ï¼Œæ”¯æŒSPAåº”ç”¨
let lastUrl = location.href;
setInterval(() => {
    if (location.href !== lastUrl) {
        lastUrl = location.href;
        extractPageText();
    }
}, 1000);

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', extractPageText, { once: true });
} else {
    extractPageText();
}
```

**æ›´å¤šå®ç°ç»†èŠ‚ç•¥**ï¼Œè¯·å‚è€ƒåŸæœ‰ä»£ç å’Œæœ¬æ–‡æ¡£æ•´ä½“æ¶æ„æè¿°è¿›è¡Œå¼€å‘ã€‚

**ğŸ’¡ è¯´æ˜ä¸æ³¨æ„**

1. **æŠ“å–æ­£æ–‡ä»…ç”¨ **`document.body.innerText`ï¼Œå®Œå…¨ä¾èµ–å¤§æ¨¡å‹è‡ªè¡Œè¿‡æ»¤å™ªå£°ã€‚
2. \*\*å®ç°äº†å¤šæ ‡ç­¾é¡µéš”ç¦»ï¼Œæ¯ä¸ªæ ‡ç­¾é¡µæ‹¥æœ‰ç‹¬ç«‹çš„æ¶ˆæ¯å†å²å’Œå†…å®¹ç¼“å­˜ã€‚
3. \*\*æ·»åŠ äº† URL å˜åŒ–æ£€æµ‹ï¼Œæ”¯æŒå•é¡µåº”ç”¨(SPA)å†…å®¹æ›´æ–°ã€‚
4. \*\*æ ‡ç­¾é¡µåˆ‡æ¢æ—¶ä¼šè‡ªåŠ¨åŠ è½½å¯¹åº”æ ‡ç­¾é¡µçš„å†…å®¹å’Œå†å²ã€‚
